var util = require('cenfo-util');
var bigInt = require('big-integer');

module.exports = {
  encriptar: function(mensaje){
    console.log('Encriptando mensaje...\n');
    console.log('Mensaje: \n' + mensaje);
    var e = util.obtener_e();
    var n = util.obtener_n();
    
    // Mensaje listo para encriptar, se obtiene como un BigInt
    var mensajeEnHexadecimal = convertirStringAHexadecimal(mensaje);
    var mensajeProcesadoParaEncriptar = bigInt(mensajeEnHexadecimal, 16);

    var mensajeEncriptado = mensajeProcesadoParaEncriptar.modPow(e, n);
    //mensajeEncriptado = convertirNumeroEnASCII(mensajeEncriptado);
    return mensajeEncriptado.toString();
  },
  desencriptar: function(codificado){
    console.log('\nDesencriptando mensaje...\n');
    console.log('Mensaje: \n' + codificado);

    var d = util.obtener_d();
    var n = util.obtener_n();

    // Mensaje listo para desencriptar, se obtiene como un BigInt
    //var mensajeProcesadoParaDesencriptar = preProcesarMensaje(codificado, n);
    var mensajeProcesadoParaDesencriptar = bigInt(codificado);

    var mensajeDesencriptado = mensajeProcesadoParaDesencriptar.modPow(d ,n);
    mensajeDesencriptado = convertirNumeroEnASCII(mensajeDesencriptado);
    //mensajeDesencriptado = Buffer.from(string, 'utf-8').toString('hex');
    return mensajeDesencriptado;
  }
  
};

preProcesarMensaje = function(mensaje, n)  {
  var mensajeEnHexadecimal = convertirStringAHexadecimal(mensaje);
  //mensajeEnHexadecimal = agregarPadding(mensajeEnHexadecimal, n);
  var mensajeNumericoPreProcesado = bigInt(mensajeEnHexadecimal, 16);
  console.log('MensajeNumericoPreProcesado: ' + mensajeNumericoPreProcesado.toString());

  return mensajeNumericoPreProcesado;
}

convertirStringAHexadecimal = function(string)  {
  var stringEnHexadecimal = Buffer.from(string, 'utf-8').toString('hex');
  console.log('String -> Hexadecimal: ' + stringEnHexadecimal);

  return stringEnHexadecimal;
}

convertirNumeroEnASCII = function(numero)  {
  console.log("Numero: " + numero.toString());
  var numeroEnHexadecimal = numero.toString(16);
  console.log('Numero -> Hexadecimal: ' + numeroEnHexadecimal);
  var hexadecimalEnString = Buffer.from(numeroEnHexadecimal, 'hex').toString('utf-8');
  console.log('Hexadecimal -> String: ' + hexadecimalEnString);

  return hexadecimalEnString;
}

agregarPadding = function(mensaje, n) {
  var cantidadDeBitsEnN = bigInt(n).bitLength() / 8;
  console.log('CantidadDeBytesEnN: ' + cantidadDeBitsEnN);
  var cantidadDeBitsEnMensaje = Buffer.byteLength(mensaje, 'utf8');
  console.log('CantidadDeBytesEnMensaje: ' + cantidadDeBitsEnMensaje);
}